---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(flexsurv)
library(survival)
library(readxl)
library(ggplot2)
library(reshape2)
library(dplyr)
library(survminer)
library(corrplot)
```

```{r}
breast_cancer_data <- read_excel("gbcs.xls")
View(breast_cancer_data)
```

```{r}
colnames(breast_cancer_data)
```
```{r}
cols <- c("menopause", "hormone", "size", "grade")

for (col in cols) {
  unique_values <- unique(breast_cancer_data[, col])
  print(paste("Unique values in col:", col))
  print(unique_values)
}
```


```{r}
X <- breast_cancer_data %>% 
  mutate(
    tumor_grade = as.factor(grade),
    received_hormone_therapy = as.factor(hormone),
    menopause_cat = as.factor(menopause),
    age_group = factor(ifelse(age <= 30, 1, ifelse(age <= 50, 2, 3))),
    survival_time = survtime,
    event_status = censdead
  ) %>% 
  select(age_group, tumor_grade, received_hormone_therapy, menopause, size, nodes, prog_recp, estrg_recp, survival_time, event_status)

View(X)
```

```{r}
str(X)
table(X$received_hormone_therapy)
table(X$tumor_grade)
table(X$event_status)
colSums(is.na(X))
```


```{r}
summary(X)
```
```{r}
numeric_cols <- sapply(X, is.numeric)
sapply(X[, numeric_cols], sd, na.rm = TRUE)
```


```{r}
colnames(X)
```
```{r}
ggplot(X, aes(x = size)) + geom_histogram(bins = 30) + theme_minimal() + ggtitle("Histogram for size")
```

```{r}
ggplot(X, aes(x = nodes)) + geom_histogram(bins = 30) + theme_minimal() + ggtitle("Histogram for nodes")
```


```{r}
ggplot(X, aes(x = prog_recp)) + geom_histogram(bins = 30) + theme_minimal() + ggtitle("Histogram for prog_recp")
```

```{r}
ggplot(X, aes(x = estrg_recp)) + geom_histogram(bins = 30) + theme_minimal() + ggtitle("Histogram for estrg_rec")
```

```{r}
ggplot(X, aes(sample = size)) + stat_qq() + stat_qq_line(color = "red") + theme_minimal()
```


```{r}
ggplot(X, aes(sample = nodes)) + stat_qq() + stat_qq_line(color = "red") + theme_minimal()
```

```{r}
ggplot(X, aes(sample = prog_recp)) + stat_qq() + stat_qq_line(color = "red") + theme_minimal()
```

```{r}
ggplot(X, aes(sample = estrg_recp)) + stat_qq() + stat_qq_line(color = "red") + theme_minimal()
```

```{r}

X_copy <- X
cols_to_std <- c("size", "nodes", "prog_recp", "estrg_recp")

for (col in cols_to_std) {
  X_copy[, col] <- scale(X_copy[, col])
}

View(X_copy)
```


```{r}
summary(breast_cancer_data$survtime)
```

### Kaplan-Meier non-parametric analysis
```{r}
# null model
km_curve <- survfit(Surv(survival_time, event_status) ~ 1, data = X)
plot(km_curve, )
```

```{r}
ggsurvplot(km_curve)
```

```{r}
km_curve_age <- survfit(Surv(survival_time, event_status) ~ age_group, data = X)
ggsurvplot(km_curve_age, title = "Kaplan-Meier Curve by age group")
```

```{r}
km_curve_tumor <- survfit(Surv(survival_time, event_status) ~ tumor_grade, data = X)
ggsurvplot(km_curve_tumor, title = "Kaplan-Meier Curve by Tumor")
```

```{r}
km_curve_hormone <- survfit(Surv(survival_time, event_status) ~ received_hormone_therapy, data = X)
ggsurvplot(km_curve_tumor, title = "Kaplan-Meier Curve by hormone")
```

```{r}
km_curve_menopause <- survfit(Surv(survival_time, event_status) ~ menopause, data = X)
ggsurvplot(km_curve_menopause, title = "Kaplan-Meier Survival Curve by Menopausal Status")
```

```{r}
km_curve_nodes <- survfit(Surv(survival_time, event_status) ~ nodes, data = X)
ggsurvplot(km_curve_nodes, title = "Kaplan-Meier Survival Curve by Number of Positive Lymph Nodes")

```

```{r}
km_curve_hormone_grade <- survfit(Surv(survival_time, event_status) ~ received_hormone_therapy + tumor_grade, data = X)
ggsurvplot(km_curve_hormone_grade, title = "Kaplan-Meier Survival Curve by Hormone Therapy and Tumor Grade")
```

```{r}
km_curve_menopause_grade <- survfit(Surv(survival_time, event_status) ~ menopause + tumor_grade, data = X)
ggsurvplot(km_curve_menopause_grade,title = "Kaplan-Meier Survival Curve by Menopause and Tumor Grade")
```

```{r}
km_curve_age_grade <- survfit(Surv(survival_time, event_status) ~ age_group + tumor_grade, data = X)
ggsurvplot(km_curve_age_grade,title = "Kaplan-Meier Survival Curve by Age Group and Tumor Grade")
```

```{r}
km_curve_menopause_age <- survfit(Surv(survival_time, event_status) ~ menopause + age_group, data = X)
ggsurvplot(km_curve_age_grade,title = "Kaplan-Meier Survival Curve by Menopause and Age Group")
```
### Cox Proportional Hazards Model
```{r}
cox.mod <- coxph(Surv(survival_time, event_status) ~ age_group + size + tumor_grade + prog_recp + nodes, data = X, method = "breslow")
summary(cox.mod)
```

```{r}
cox.mod.simple <- coxph(Surv(survival_time, event_status) ~ received_hormone_therapy, data = X)
ggsurvplot(survfit(cox.mod.simple), data = X, pval = TRUE, conf.int = TRUE, risk.table = TRUE)
```
```{r}
cox.mod.simple <- coxph(Surv(survival_time, event_status) ~ age_group, data = X)
ggsurvplot(survfit(cox.mod.simple), data = X, pval = TRUE, conf.int = TRUE, risk.table = TRUE)
```


```{r}
ggsurvplot(survfit(cox.mod), data = X, pval = TRUE, conf.int = TRUE, risk.table = TRUE, title = "Cox Proportional Hazards Survival Curves")
```
```{r}
corr_matrix <- cor(X_copy[, c("size", "nodes", "prog_recp", "estrg_recp")])
print(corr_matrix)
```

```{r}
corrplot(corr_matrix)
```

```{r}
corrplot(corr_matrix, method = "color")
```

### Exponential Model
# without categorical variable
```{r}
exp_model_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp, data = X_copy, dist = "exp")

exp_model <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp, data = X_copy, dist = "exp")

summary(exp_model_fs)
summary(exp_model)
```
```{r}
exp_rm_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp, data = X_copy, dist = "exp")

exp_rm <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp, data = X_copy, dist = "exp")

summary(exp_rm)
```

```{r}
plot(exp_model_fs, main = "Original Exponential Survival Model w/o Categorical Variables", xlab = "Time", ylab = "Survival Probability")
```

```{r}
plot(exp_rm_fs, main = "Updated Exponential Survival Model w/o Categorical Variables", xlab = "Time", ylab = "Survival Probability")
```


# with categorical variables
```{r}
exp_model_cat_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp + age_group + tumor_grade + received_hormone_therapy + menopause, data = X_copy, dist = "exp")

exp_model_cat <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp + age_group + tumor_grade + received_hormone_therapy + menopause, data = X_copy, dist = "exp")

summary(exp_model_cat_fs)
summary(exp_model_cat)
```

```{r}
plot(exp_model_cat_fs, main = "Original Exponential Model with Categorical Variables", xlab = "Time", ylab = "Survival Probabilities")
```


```{r}
exp_model_cat_rm_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + tumor_grade + prog_recp + age_group, data = X_copy, dist = "exp")

exp_model_cat_rm <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + age_group + tumor_grade, data = X_copy, dist = "exp")

summary(exp_model_cat_rm_fs)
summary(exp_model_cat_rm)
```


```{r}
plot(exp_model_cat_rm_fs, main = "Updated Exponential Model with Categorical Variables", xlab = "Time", ylab = "Survival Probabilities")
```


### Weibull model
# without categorical variables
```{r}
weibull_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp, data = X_copy, dist = "weibull")

weibull <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp, data = X_copy, dist = "weibull")

summary(weibull_fs)
summary(weibull)
```

```{r}
weibull_rm_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp, data = X_copy, dist = "weibull")

weibull_rm <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp, data = X_copy, dist = "weibull")

summary(weibull_rm_fs)
summary(weibull_rm)
```


```{r}
plot(weibull_fs, main = "Original Weibull w/o Categorical Variables", xlab = "Time", ylab = "Survival Probabilities")
```

```{r}
plot(weibull_rm_fs, main = "Updated Weibull w/o Categorical Variables", xlab = "Time", ylab = "Survival Probabilities")
```


# with categorical variables
```{r}
weibull_cat_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp + age_group + tumor_grade + received_hormone_therapy + menopause, data = X_copy, dist = "weibull")

weibull_cat <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp + age_group + tumor_grade + received_hormone_therapy, data = X_copy, dist = "weibull")

summary(weibull_cat_fs)
summary(weibull_cat)
```

```{r}
plot(weibull_cat_fs, main = "Original Weibull with Categorical Variables", xlab = "Time", ylab = "Survival Probabilities")
```

```{r}
weibull_cat_rm_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + age_group + tumor_grade + received_hormone_therapy, data = X_copy, dist = "weibull")

weibull_cat_rm <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + age_group + tumor_grade + received_hormone_therapy, data = X_copy, dist = "weibull")
```


### Log-normal distribution
# without categorical variables
```{r}
lognormal_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp, data = X_copy, dist = "lognormal")

lognormal <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp, data = X_copy, dist = "lognormal")

summary(lognormal_fs)
summary(lognormal)
```

```{r}
plot(lognormal_fs, main = "Original Log-normal w/o Categorical Variables", xlab = "Time", ylab = "Survival Probabilities")
```

```{r}
lognormal_rm_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp, data = X_copy, dist = "lognormal")

lognormal_rm <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp, data = X_copy, dist = "lognormal")

summary(lognormal_rm_fs)
summary(lognormal_rm)
```

```{r}
plot(lognormal_rm_fs, xlab = "Time", ylab = "Survival Probabilities", main = "Updated Lognormal without Categorical Variables")
```


# with categorical variable
```{r}
lognormal_cat_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp + age_group + tumor_grade + received_hormone_therapy + menopause, data = X_copy, dist = "lognormal")

lognormal_cat <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + estrg_recp + age_group + tumor_grade + received_hormone_therapy + menopause, data = X_copy, dist = "lognormal")

summary(lognormal_cat_fs)
summary(lognormal_cat)
```

```{r}
plot(lognormal_cat_fs, xlab = "Time", ylab = "Survival Probabilities", main = "Original Lognormal with Categorical Variables")
```


```{r}
lognormal_cat_rm_fs <- flexsurvreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + age_group + tumor_grade + received_hormone_therapy, data = X_copy, dist = "lognormal")

lognormal_cat_rm <- survreg(Surv(survival_time, event_status) ~ size + nodes + prog_recp + age_group + tumor_grade + received_hormone_therapy, data = X_copy, dist = "lognormal")

summary(lognormal_cat_rm_fs)
summary(lognormal_cat_rm)
```

```{r}
plot(lognormal_cat_rm_fs, xlab = "Time", ylab = "Survival Probabilities", main = "Updated Lognormal with Categorical Variables")
```